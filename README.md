# gc-kafka-reader

Компонент предназначен для чтения сообщений и сбора статистики из Apache Kafka с заданными параметрами.


## Системные требования

- В системе необходимо иметь установленную Java версии не ниже 8


## Конфигурирование

Профили конфигураций компонента определяется в конфигурационном файле Spring Boot. Формат файла - [YAML](http://www.yaml.org/spec/1.2/spec.html), пример находится в проекте:

```
src/main/resources/application.yml
```

Документация по использованию [YAML конфигурации в Spring Boot](http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html#boot-features-external-config-yaml)

Пример конфигурации для GC2:

```
spring:
  application:
    name: gc-kafka-reader
    index: 1

server:
  port: 5070
  address: 0.0.0.0

kafka:
  address: "10.0.10.247:9092,110.0.10.248:9092,10.0.10.250:9092,10.0.10.225:9092,10.0.10.224:9092,10.0.10.223:9092"
  topic:
    message:
      name: teledata
      type: teledata # teledata / short-teledata / eventdata / sensor
      group-id: gc-kafka-reader-debug
      client-id: gc-kafka-reader-debug

logger:
  operators:
    - 1002
    - 1004
    - 1005
  devops:
#    - 124554052586
#    - 60129543146
  start-date: "2018-09-01T00:00:00.000Z"
  end-date:   "2018-10-01T00:00:00.000Z"
  protobuf: true
  stat-period: 100
```

- В параметре **name** задается наименование топика Apache Kafka.
- В параметре **type** задается тип сообщения Protobuf (teledata - MESSAGE, short-teledata - SHORT_MESSAGE, eventdata - EVENT, sensor - SENSOR_WRAPPER).
- Если для параметров **operators**, **devops**, **start-date**, **end-date** не заданы значения, то логируются все сообщения заданного типа.
- Если задан список ID операторов **operators**, то логируются только сообщения от этих операторов.
- Если задан список устройств (ID устройств / ID операторов) **devops**, то логируются только сообщения от этих устройств, а параметр **operators** игнорируются.
- Если задан параметр **start-date**, то логируются только сообщения начиная с этой даты.
- Если задан параметр **end-date**, то логируются только сообщения со временем не больше этой даты.
- Если значение параметра **protobuf** выставлено в true, то логируется содержимое Protobuf.
- Если задан параметр **stat-period** (число), то с этой периодичностью рассчитывается статистика (например, если для **stat-period** задано значение 100, то после каждого 100-го сообщения будет рассчитана статистика). Формат статистики зависит от типа сообщения.

Например, для приведенного выше примера будет осуществляться логирование сообщений Teledata от операторов 1002, 1004, 1005 во временном интервале от 2018-09-01T00:00:00.000Z до 2018-10-01T00:00:00.000Z с выводом содержимого Protobuf и расчетом статистики с периодом 100.

Для каждого сообщения в лог выводится строка следующего вида: 
```
17.09.2018 07:26:39 INFO  KafkaMessageListener     -> 2018-09-01T09:04:01Z [Sensordata]: Unit ======> unitId: 897648165866, deviceId: 209, operatorId: 1002
```
где 2018-09-01T09:04:01Z [Sensordata] - время сообщения / тип сообщения,
unitId - ключ сообщения из Apache Kafka.

Пример статистики для teledata / MESSAGE:
```
----------------------------------------- Статистика -------------------------------------------

	Прочитано сообщений:				120260
	из них:
	сообщений оператора 1002:			119072
	сообщений оператора 1004:			729
	сообщений оператора 1005:			459
	Сообщений с координатами:			120260
	С валидными координатами:			112669
	Сообщений с digital sensor:			120260
	Сообщений с analog sensor:			497
	Сообщений с counter sensor:			0
	Сообщений с liquid sensor:			1186
	Сообщений с can sensor:   			3558
	Сообщений с marker_data:			729
```

Пример статистики для short-teledata / SHORT_MESSAGE:
```
----------------------------------------- Статистика -------------------------------------------

	Прочитано сообщений:				174030
	из них:
	сообщений оператора 1002:			162620
	сообщений оператора 1004:			11410
	С валидными координатами:			161623
```

Пример статистики для eventdata / EVENT:
```
----------------------------------------- Статистика -------------------------------------------

	Прочитано сообщений:				89380
	из них:
	сообщений оператора 1002:			88988
	сообщений оператора 1004:			195
	сообщений оператора 1005:			197
	Сообщений с координатами:			89339
	С валидными координатами:			89339
	событий с типом    2:				173
	событий с типом    3:				2846
	событий с типом    5:				2502
	событий с типом   19:				1028
	событий с типом   20:				1054
	событий с типом   21:				78599
	событий с типом   22:				3137
	событий с типом 3000:				11
	событий с типом 3001:				25
	событий с типом 3002:				5
```

Пример статистики для sensor / SENSOR_WRAPPER:
```
----------------------------------------- Статистика -------------------------------------------

	Прочитано сообщений:				143310
	из них:
	сообщений оператора 1002:			143107
	сообщений оператора 1004:			97
	сообщений оператора 1005:			106
	сообщений с типом 1:				143310
```

Пример запуска компонента версии 0.0.1 из командной строки:
```
java -jar gc-kafka-reader-0.0.1.jar -Dspring.config.location=application.yml

```
